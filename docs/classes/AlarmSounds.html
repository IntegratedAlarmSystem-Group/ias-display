<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>ias-display documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">ias-display documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content class">
                   <div class="content-data">











<ol class="breadcrumb">
  <li>Classes</li>
  <li>AlarmSounds</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/data/alarm.service.ts</code>
        </p>

            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>Class used to model the different sound options and their corresponding audio files</p>

            </p>




            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Static</span>
                                <a href="#none">none</a>
                            </li>
                            <li>
                                    <span class="modifier">Static</span>
                                <a href="#type1">type1</a>
                            </li>
                            <li>
                                    <span class="modifier">Static</span>
                                <a href="#type2">type2</a>
                            </li>
                            <li>
                                    <span class="modifier">Static</span>
                                <a href="#type3">type3</a>
                            </li>
                            <li>
                                    <span class="modifier">Static</span>
                                <a href="#type4">type4</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Static</span>
                                <a href="#getSoundsource">getSoundsource</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>


            <section>
    
        <h3 id="inputs">
            Properties
        </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="none"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Static</span>
                            none</b>
                            <a href="#none"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>&#x27;&#x27;</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="22" class="link-to-prism">src/app/data/alarm.service.ts:22</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description"><p>This is the type for alarms with no sound </p>
</div>
                    </td>
                </tr>

            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="type1"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Static</span>
                            type1</b>
                            <a href="#type1"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>&#x27;Alarm_Sound_1.mp3&#x27;</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="25" class="link-to-prism">src/app/data/alarm.service.ts:25</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description"><p>The name of the audio file associated to the sound TYPE1 </p>
</div>
                    </td>
                </tr>

            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="type2"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Static</span>
                            type2</b>
                            <a href="#type2"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>&#x27;Alarm_Sound_2.mp3&#x27;</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="28" class="link-to-prism">src/app/data/alarm.service.ts:28</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description"><p>The name of the audio file associated to the sound TYPE2 </p>
</div>
                    </td>
                </tr>

            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="type3"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Static</span>
                            type3</b>
                            <a href="#type3"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>&#x27;Alarm_Sound_3.mp3&#x27;</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="31" class="link-to-prism">src/app/data/alarm.service.ts:31</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description"><p>The name of the audio file associated to the sound TYPE3 </p>
</div>
                    </td>
                </tr>

            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="type4"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Static</span>
                            type4</b>
                            <a href="#type4"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>&#x27;Alarm_Sound_4.mp3&#x27;</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="34" class="link-to-prism">src/app/data/alarm.service.ts:34</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description"><p>The name of the audio file associated to the sound TYPE4 </p>
</div>
                    </td>
                </tr>

            </tbody>
        </table>
</section>

            <section>
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getSoundsource"></a>
                    <span class="name">
                        <b>
                            <span class="modifier">Static</span>
                            getSoundsource
                        </b>
                        <a href="#getSoundsource"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getSoundsource(sound: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="41"
                            class="link-to-prism">src/app/data/alarm.service.ts:41</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Given a sound type, retruns the associated audiofile</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                    <td>Description</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>sound</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                    <td>
                                        <p>The sound type, e.g. TYPE1, TYPE2, etc.</p>

                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                    </div>
                    <div class="io-description">
                        <p>the filepath of the corresponding audio file</p>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>





    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable, NgZone } from &#x27;@angular/core&#x27;;
import { map, auditTime } from &#x27;rxjs/operators&#x27;;
import { BehaviorSubject } from &#x27;rxjs&#x27;;
import { interval } from &#x27;rxjs&#x27;;
import { WebSocketBridge } from &#x27;django-channels&#x27;;
import { Howl, Howler} from &#x27;howler&#x27;;
import { environment } from &#x27;../../environments/environment&#x27;;
import { Alarm, Validity, Value } from &#x27;../data/alarm&#x27;;
import { AlarmConfig } from &#x27;../data/alarm-config&#x27;;
import { BackendUrls, Streams, Assets } from &#x27;../settings&#x27;;
import { CdbService } from &#x27;../data/cdb.service&#x27;;
import { HttpClientService } from &#x27;./http-client.service&#x27;;
import { AuthService } from &#x27;../auth/auth.service&#x27;;


/**
* Class used to model the different sound options and their corresponding audio files
*/
export class AlarmSounds {

  /** This is the type for alarms with no sound */
  static none &#x3D; &#x27;&#x27;;

  /** The name of the audio file associated to the sound TYPE1 */
  static type1 &#x3D; &#x27;Alarm_Sound_1.mp3&#x27;;

  /** The name of the audio file associated to the sound TYPE2 */
  static type2 &#x3D; &#x27;Alarm_Sound_2.mp3&#x27;;

  /** The name of the audio file associated to the sound TYPE3 */
  static type3 &#x3D; &#x27;Alarm_Sound_3.mp3&#x27;;

  /** The name of the audio file associated to the sound TYPE4 */
  static type4 &#x3D; &#x27;Alarm_Sound_4.mp3&#x27;;

  /**
  * Given a sound type, retruns the associated audiofile
  * @param {string} sound The sound type, e.g. TYPE1, TYPE2, etc.
  * @returns {string} the filepath of the corresponding audio file
  */
  static getSoundsource(sound: string): string {
    if (sound &#x3D;&#x3D;&#x3D; &#x27;TYPE1&#x27;) {
      return Assets.SOUNDS + AlarmSounds.type1;
    } else if (sound &#x3D;&#x3D;&#x3D; &#x27;TYPE2&#x27;) {
      return Assets.SOUNDS + AlarmSounds.type2;
    } else if (sound &#x3D;&#x3D;&#x3D; &#x27;TYPE3&#x27;) {
      return Assets.SOUNDS + AlarmSounds.type3;
    } else if (sound &#x3D;&#x3D;&#x3D; &#x27;TYPE4&#x27;) {
      return Assets.SOUNDS + AlarmSounds.type4;
    }
    return null;
  }
}

/**
* Service that connects and receives {@link Alarm} messages from the
* IAS Webserver through Websockets
*/
@Injectable()
export class AlarmService {

  /**
  * Timestamp related with the last received message
  */
  public lastReceivedMessageTimestamp: number &#x3D; (new Date).getTime();

  /**
  * Stream of notifications of changes in
  * the status of the service connection
  */
  public connectionStatusStream &#x3D; new BehaviorSubject&lt;any&gt;(false);

  /**
  * Array of {@link Alarm} objects
  */
  public alarmsArray: Alarm[] &#x3D; [];

  /**
  * Index for the alarmsArray { core_id: arrayIndex }
  */
  public alarmsIndexes: {[core_id: string]: number} &#x3D; {};

  /**
  * Stream of notifications of changes in the dictionary of {@link Alarm} objects
  */
  public alarmChangeStream &#x3D; new BehaviorSubject&lt;any&gt;(true);

  /**
  * Stream of notifications to control the delivery of changes in the dictionary of {@link Alarm} objects
  */
  public alarmChangeInputStream &#x3D; new BehaviorSubject&lt;any&gt;(true);

  /**
  * Stream of notifications of changes in the counter related to the dictionary of {@link Alarm} objects
  */
  public counterChangeStream &#x3D; new BehaviorSubject&lt;any&gt;({});

  /**
  * Stream of notifications to control the delivery of changes in the counter related to the dictionary of {@link Alarm} objects
  */
  public counterChangeInputStream &#x3D; new BehaviorSubject&lt;any&gt;({});

  /**
  * Stream of notifications to control the delivery of changes in the dictionary of {@link Alarm} objects
  */
  public alarmChangeBufferStream &#x3D; new BehaviorSubject&lt;any&gt;(true);

  /**
  * Stream of notifications to control the delivery of changes in the counter related to the dictionary of {@link Alarm} objects
  */
  public counterChangeBufferStream &#x3D; new BehaviorSubject&lt;any&gt;({});

  /**
  * Stream of notifications to control the delivery of changes in the dictionary of {@link Alarm} objects
  */
  public alarmChangeBufferList &#x3D; [];

  /**
  * Django Channels WebsocketBridge,
  * used to connect to Django Channels through Websockets
  */
  public webSocketBridge: WebSocketBridge &#x3D; new WebSocketBridge();

  /**
  * Defines wether or not the display should emit sounds when alarms are triggered.
  * It is used to avoid sounds when the page is refreshed, and only allow them after that
  */
  public canSound: boolean;

  /**
  * Reference to the audio object used to play the sounds
  */
  public sound: Howl;

  /**
  * Id of the currenlty sounding Alarm
  */
  public soundingAlarm: string;

  /**
  * Defines wether or not the service is initialized
  */
  public isInitialized &#x3D; false;

  /**
  * Information about the count of alarms by view
  */
  public countByView &#x3D; {};

  /**
  * Connection status timer
  */
  public connectionStatusTimer: any;

  /**
   * Builds an instance of the service
   * @param {CdbService} cdbService Service used to get complementary alarm information
   * @param {HttpClientService} httpClientService Service used to perform HTTP requests
   * @param {AuthService} authService Service used for authentication
   * @param {NgZone} ngZone Service used for executing work inside or outside of the Angular Zone
   */
  constructor(
    private cdbService: CdbService,
    private httpClientService: HttpClientService,
    private authService: AuthService,
    private ngZone: NgZone
  ) {
    this.connectionStatusStream.subscribe(
      value &#x3D;&gt; {
        if (value &#x3D;&#x3D;&#x3D; false) {
          this.triggerAlarmsNonValidConnectionState();
        }
      }
    );
    this.authService.loginStatusStream.subscribe(
      value &#x3D;&gt; {
        if (value &#x3D;&#x3D;&#x3D; true) {
          this.initialize();
        } else {
          this.destroy();
        }
      }
    );

    this.alarmChangeInputStream.subscribe(
      changes &#x3D;&gt; {
        this.ngZone.run(
          () &#x3D;&gt; {
            this.alarmChangeStream.next(changes);
          }
        );
      }
    );

    this.counterChangeInputStream.subscribe(
      countByView &#x3D;&gt; {
        this.ngZone.run(
          () &#x3D;&gt; {
            this.counterChangeStream.next(countByView);
          }
        );
      }
    );

    this.alarmChangeBufferStream.subscribe(
      change &#x3D;&gt; {
        this.bufferStreamTasks(change);
      }
    );

    this.counterChangeBufferStream.subscribe(
      countByView &#x3D;&gt; {
        this.counterStreamTasks(countByView);
      }
    );

  }

  /**
  * Sends an {@link Alarm} change event
  *
  * @param {Any} changes the list of core_ids of the updated Alarms, or &#x27;all&#x27; if all were updated
  */
  changeAlarms(changes: any) {
    this.alarmChangeBufferStream.next(changes);
  }

  /**
  * Sends a counters change event
  *
  * @param {Any} changes the dictionary of count value sindexed by view
  */
  changeCounter(any: any) {
    this.counterChangeBufferStream.next(any);
  }

  /******* SERVICE INITIALIZATION *******/

  /**
  * Setup periodical push from buffer
  */
  setPeriodicalPullFromBuffer() {
    setInterval( () &#x3D;&gt; {
      const changes &#x3D; this.getChangesFromBuffer();
      if (changes.length &gt; 0) {
        this.alarmChangeInputStream.next(changes);
        this.counterChangeInputStream.next(this.countByView);
      }
    }, 250);
  }

  /**
  * Setup tasks for data received in the buffer
  */
  bufferStreamTasks(change: any) {
    this.updateAlarmChangeBuffer(change);
  }

  /**
  * Setup tasks for counter data
  */
  counterStreamTasks(countByView: any) {
    this.readCountByViewMessage(countByView);
  }

  /**
  * Method to manage the update of the buffer for a new alarm change
  */
  updateAlarmChangeBuffer(changes: string) {
    if (changes &#x3D;&#x3D;&#x3D; &#x27;all&#x27;) {
      this.alarmChangeBufferList &#x3D; [&#x27;all&#x27;];
    } else {
      this.alarmChangeBufferList &#x3D; this.alarmChangeBufferList.concat(changes);
    }
  }

  /**
  * Get list of alarms with graphical components to update from the buffer
  */
  getChangesFromBuffer() {
    if (this.alarmChangeBufferList.indexOf(&#x27;all&#x27;) &gt;&#x3D; 0) {
      this.alarmChangeBufferList &#x3D; [];
      return [&#x27;all&#x27;];
    }
    let changes: string[] &#x3D; [];
    const alarmChangeBuffer &#x3D; new Set(this.alarmChangeBufferList);
    this.alarmChangeBufferList &#x3D; [];
    if (alarmChangeBuffer.size &gt; 10 ) {
      // console.log(&#x27;Changes over buffer size reference &#x27;, this.alarmChangeBuffer.size);
      changes &#x3D; [&#x27;all&#x27;];
    } else {
      changes &#x3D; Array.from(alarmChangeBuffer);
    }
    return changes;
  }

  /**
  * Start connection to the backend through websockets
  */
  initialize() {
    if (this.isInitialized || !this.authService.loginStatus) {
      return;
    }
    this.cdbService.initialize();
    this.isInitialized &#x3D; true;
    this.canSound &#x3D; false;
    this.connect();
    this.ngZone.runOutsideAngular(
      () &#x3D;&gt; {
        this.webSocketBridge.socket.addEventListener(
          &#x27;open&#x27;, () &#x3D;&gt; {
            this.connectionStatusStream.next(true);
            this.getAlarmList();
          }
        );
        this.webSocketBridge.socket.addEventListener(
          &#x27;close&#x27;, () &#x3D;&gt; {
            this.resetCountByView();
          }
        );
        this.webSocketBridge.demultiplex(Streams.ALARMS, (payload: any, streamName: any) &#x3D;&gt; {
        // console.log(&#x27;notify &#x27;, payload);
          if (this.authService.loginStatus) {
            this.resetTimer();
            this.readAlarmMessagesList(payload.alarms, false);
            this.counterChangeBufferStream.next(payload.counters);
          }
        });
        this.webSocketBridge.demultiplex(Streams.UPDATES, (payload: any, streamName: any) &#x3D;&gt; {
          // console.log(&#x27;request&#x27;, payload);
          if (this.authService.loginStatus) {
            this.resetTimer();
            this.readAlarmMessagesList(payload.alarms, true);
            this.counterChangeBufferStream.next(payload.counters);
          }
        });
      }
    );
    this.setPeriodicalPullFromBuffer();
  }

  /**
  *  Start connection to the backend through websockets
  */
  connect() {
    this.ngZone.runOutsideAngular(
      () &#x3D;&gt; {
        const connectionPath &#x3D; this.getConnectionPath();
        this.webSocketBridge.connect(connectionPath);
        this.webSocketBridge.listen(connectionPath);
        console.log(&#x27;Connected to webserver at&#x27;);
    });
  }

  /**
  *  Connection path using authentication data
  */
  getConnectionPath() {
    return environment.websocketPath + &#x27;?token&#x3D;&#x27; + this.authService.getToken();
  }

  /**
  *  Disconnect from the backend
  */
  destroy() {
    // Close connection
    if (this.isInitialized) {
      this.webSocketBridge.stream(Streams.UPDATES).send({
        &#x27;action&#x27;: &#x27;close&#x27;
      });
      this.webSocketBridge.socket.close(
        1000, &#x27;User logout&#x27;, {keepClosed: true});
      this.resetCountByView();
    }
    this.isInitialized &#x3D; false;
    console.log(&#x27;Connection to webserver closed&#x27;);
  }

  /******* ALARM HANDLING *******/

  /**
   * Returns an Alarm object
   * @param core_id core_id of the Alarm to return
   * @returns {Alarm} Alarm object corresponding to the given core_id
   */
  get(core_id: string): Alarm {
    return this.alarmsArray[this.alarmsIndexes[core_id]] as Alarm;
  }

  /**
   * Returns a boolean to check if there is information available about an alarm
   * @param core_id core_id of the Alarm
   * @returns {boolean} true if there is information about the alarm
   */
  isAlarmIndexAvailable(core_id: string): boolean {
    return (core_id in this.alarmsIndexes);
  }

  /**
  * Returns the instance of the {@link Alarm} associated to a given {@link AlarmConfig}
  * @param {AlarmConfig} config the corresponding AlarmConfig from where to get the {@link Alarm}
  * @returns {Alarm} the {@link Alarm} associated to the given {@link AlarmConfig}
  */
  getAlarm(config: AlarmConfig): Alarm {
    if (config) {
      return this.get(config.alarm_id);
    }
  }

  /**
  * Returns the custom_name of the {@link Alarm} given a corresponding {@link AlarmConfig}.
  * If there is no custom_name, it returns the alarm_id
  * @param {AlarmConfig} config the corresponding AlarmConfig from where to get the {@link Alarm}
  * @returns {string} the name associated to the given {@link AlarmConfig}
  */
  getName(config: AlarmConfig): string {
    if (config) {
      if (config.custom_name) {
        return config.custom_name;
      } else {
        return config.alarm_id;
      }
    }
  }

  /**
   * Acknowledges a list of Alarms with a message
   * @param {string[]} alarm_ids list of ids of the alarms to acknowledge
   * @param {string} message message of the acknowledgement
   * @param {string} user user that performs the acknowledgement
   * @returns {json} response of the HTTP request of the acknowledge
   */
  acknowledgeAlarms(alarms_ids: string[], message: string, user: string): any {
    const data &#x3D; {
      &#x27;alarms_ids&#x27;: alarms_ids,
      &#x27;message&#x27;: message,
      &#x27;user&#x27;: user
    };
    return this.httpClientService.put(BackendUrls.TICKETS_MULTIPLE_ACK, data).pipe(
    map(
      (response) &#x3D;&gt; {
        for (const id of alarms_ids) {
          const alarm &#x3D; this.get(id);
          alarm.acknowledge();
        }
        return response;
      }
    ));
  }

  /**
   * Get information about old tickets related to a target alarm
   * @param alarm_id id of the target alarm
   * @returns {any[]} response of the HTTP request with a dictionary with information about missing acks
   */
  getMissingAcks(alarm_id: string) {
    const url &#x3D; BackendUrls.TICKETS_INFO + &#x27;?alarm_id&#x3D;&#x27; + alarm_id;
    return this.httpClientService.get(url).pipe(
    map(
      (response) &#x3D;&gt; {
        return response;
      }
    ));
  }

  /**
   * Gets the open {@link ShelveRegistry} for an {@link Alarm}
   * @param {string} alarm_id id of the target alarm
   * @param {number} status id of the target alarm
   * @returns {json} response of the HTTP request with a dictionary with information about missing acks
   */
  getShelveRegistries(alarm_id: string, status: number): any {
    const url &#x3D; BackendUrls.SHELVE_REGS_FILTER + &#x27;?alarm_id&#x3D;&#x27; + alarm_id + &#x27;&amp;status&#x3D;&#x27; + status;
    return this.httpClientService.get(url).pipe(
    map(
      (response) &#x3D;&gt; {
        return response;
      }
    ));
  }

  /**
   * Shelves and {@link Alarm} with a message
   * @param {string} alarm_id id of the alarm to shelve
   * @param {string} message message of the shelving
   * @param {string} timeout the timeout for the shelving
   * @param {string} user the user who performed the shelving
   * @returns {json} response of the HTTP request of the shelve
   */
  shelveAlarm(alarm_id: string, message: string, timeout: string, user: string): any {
    const data &#x3D; {
      &#x27;alarm_id&#x27;: alarm_id,
      &#x27;message&#x27;: message,
      &#x27;timeout&#x27;: timeout,
      &#x27;user&#x27;: user
    };
    return this.httpClientService.post(BackendUrls.SHELVE_API, data).pipe(
    map(
      (response) &#x3D;&gt; {
        if (response[&#x27;status&#x27;] &#x3D;&#x3D;&#x3D; 201) {
          const alarm &#x3D; this.get(alarm_id);
          alarm.shelve();
        }
        return response;
      }
    ));
  }

  /**
   * Shelves and {@link Alarm} with a message
   * @param {string[]} alarms_ids id of the alarm to shelve
   * @param {string} message message of the shelving
   * @returns {json} response of the HTTP request of the shelve
   */
  unshelveAlarms(alarms_ids: string[], message: string): any {
    const data &#x3D; {
      &#x27;alarms_ids&#x27;: alarms_ids,
    };
    return this.httpClientService.put(BackendUrls.UNSHELVE_API, data).pipe(
    map(
      (response) &#x3D;&gt; {
        if (response[&#x27;status&#x27;] &#x3D;&#x3D;&#x3D; 200) {
          for (const id of alarms_ids) {
            const alarm &#x3D; this.get(id);
            alarm.unshelve();
          }
        }
        return response;
      }
    ));
  }

  /******* HANDLING OF ALARM MESSAGES FROM THE CORE *******/

  /**
  * Get the complete list of alarms from the webserver database
   * through the websocket
   */
  getAlarmList() {
    this.webSocketBridge.stream(Streams.UPDATES).send({
      &#x27;action&#x27;: &#x27;list&#x27;
    });
  }

  /**
   * Reads a list of alarm messages form the Core and add them to the service alarms list.
   * Sends the corresponding notification in the {@link AlarmService#alarmChangeBufferStream}, by calling {@link AlarmService#changeAlarms}
   * @param {Object[]} alarmsList list of dictionaries with values for alarm fields (as generic objects)
   * @param {boolean} allChanged true if the list is a general change in all the alarms, false if not
   */
  readAlarmMessagesList(alarmsList: Object[], allChanged: boolean &#x3D; false) {
    const changed &#x3D; [];
    for (const obj of alarmsList) {
      const alarm &#x3D; Alarm.asAlarm(obj);
      this.add_or_update_alarm(alarm);
      changed.push(alarm.core_id);
    }
    if (allChanged) {
      this.changeAlarms(&#x27;all&#x27;);
    } else {
      this.changeAlarms(changed);
    }
    this.canSound &#x3D; true;
  }

  /**
   * Reads the count by view object received from the webserver
   * @param {Object} countByView
   */
  readCountByViewMessage(countByView: Object) {
    this.countByView &#x3D; countByView;
  }

  /**
   * Method to clear the count by view if there is the ws connection is closed
   */
  resetCountByView() {
    this.countByView &#x3D; {};
  }

  /**
   * Adds or updates an {@link Alarm} to the AlarmService
   * @param {Alarm} alarm the {@link Alarm} to add or update
   */
  add_or_update_alarm(alarm: Alarm) {
    let old_alarm_value &#x3D; Value.cleared;
    let old_alarm_ack &#x3D; true;
    if (alarm.core_id in this.alarmsIndexes) {
      const old_alarm &#x3D; this.alarmsArray[this.alarmsIndexes[alarm.core_id]];
      old_alarm_value &#x3D; old_alarm.value;
      old_alarm_ack &#x3D; old_alarm.ack;
      this.alarmsArray[this.alarmsIndexes[alarm.core_id]] &#x3D; alarm;
    } else {
      const newLength &#x3D; this.alarmsArray.push(alarm);
      this.alarmsIndexes[alarm.core_id] &#x3D; newLength - 1;
    }
    if (old_alarm_value &#x3D;&#x3D;&#x3D; Value.cleared &amp;&amp; alarm.value !&#x3D;&#x3D; Value.cleared) {
      if (alarm.sound !&#x3D;&#x3D; &#x27;NONE&#x27;) {
        this.playAlarmSound(alarm);
      }
    }
    if (old_alarm_value !&#x3D;&#x3D; Value.cleared &amp;&amp; alarm.value &#x3D;&#x3D;&#x3D; Value.cleared) {
      if (alarm.sound !&#x3D;&#x3D; &#x27;NONE&#x27;) {
        this.clearSoundsIfAck(alarm);
      }
    }
    if (!old_alarm_ack &amp;&amp; alarm.ack) {
      if (alarm.sound !&#x3D;&#x3D; &#x27;NONE&#x27;) {
        this.clearSoundsIfAck(alarm);
      }
    }
  }

  /**
   * Reproduces the sound of a given {@link Alarm}
   * @param {Alarm} alarm the {@link Alarm}
   */
  playAlarmSound(alarm: Alarm) {
    if (!this.canSound || alarm.shelved) {
      return;
    }
    const repeat &#x3D; alarm.shouldRepeat();
    if (repeat || !this.sound || !this.sound.playing()) {
      this.soundingAlarm &#x3D; alarm.core_id;
      this.emitSound(alarm.sound, repeat);
    }
  }

  /**
   * Reproduces a sound
   * @param {string} sound the sound of the Alarm to reproduce
   * @param {boolean} repeat true if the sound should be repeated, false if not.
   */
  emitSound(sound: string, repeat: boolean) {
    const soundToPlay &#x3D; AlarmSounds.getSoundsource(sound);
    if (soundToPlay &#x3D;&#x3D;&#x3D; null || soundToPlay &#x3D;&#x3D;&#x3D; &#x27;&#x27;) {
      return;
    }
    this.stopSound();
    this.sound &#x3D; new Howl({
      src: [soundToPlay],
      autoplay: true,
      loop: repeat
    });
  }

  /**
   * Stops the sound of a given {@link Alarm}, only if the sound is being repeated
   * It is intended to be used when critical alarms (repeated) are acknowledged.
   * Once the sound stops, it checks if there is another non-acknowledged alarm and plays its sound repeatedly.
   * by calling {@link AlarmService.html#playAlarmSound}
   * @param {Alarm} alarm the {@link Alarm}
   */
  clearSoundsIfAck(alarm: Alarm) {
    this.stopSound();
    if (!alarm.shouldRepeat()) {
      return;
    }
    if (this.soundingAlarm &#x3D;&#x3D;&#x3D; alarm.core_id) {
      this.soundingAlarm &#x3D; null;
      for (alarm of this.alarmsArray) {
        if (!alarm.ack &amp;&amp; alarm.sound !&#x3D;&#x3D; &#x27;NONE&#x27; &amp;&amp; alarm.shouldRepeat()) {
          this.playAlarmSound(alarm);
          return;
        }
      }
    }
  }

  /**
   * If there is a sound defined, it stops it
   */
  stopSound() {
    if (this.sound) {
      this.sound.stop();
    }
  }

  /******* PERIODIC CHECK OF VALIDITY OF ALARMS *******/

  /**
   * Set selected state to alarms under an non-valid connection
   */
  triggerAlarmsNonValidConnectionState() {
    for (const alarm of this.alarmsArray) {
      alarm.validity &#x3D; Validity.unreliable;
      this.add_or_update_alarm(Alarm.asAlarm(Object.assign({}, alarm)));
    }
    this.changeAlarms(&#x27;all&#x27;);
  }

  /**
   * Resets the status connection check timer
   * The timer&#x27;s period is equal to the broadcastThreshold obtained by {@link CdbService.html#getBroadcastRate}
   */
  resetTimer() {
    if (this.connectionStatusTimer) {
      this.connectionStatusTimer.unsubscribe();
      this.connectionStatusStream.next(true);
    }
    const broadcastThreshold &#x3D; this.cdbService.getBroadcastThreshold();
    this.connectionStatusTimer &#x3D; interval(1000 * broadcastThreshold).subscribe( () &#x3D;&gt; {
      this.connectionStatusStream.next(false);
    });
  }
}
</code></pre>
    </div>
</div>







                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'class';
            var COMPODOC_CURRENT_PAGE_URL = 'AlarmSounds.html';
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
