<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>ias-display documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">ias-display documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content class">
                   <div class="content-data">











<ol class="breadcrumb">
  <li>Classes</li>
  <li>AlarmSounds</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/data/alarm.service.ts</code>
        </p>

            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>Class used to model the different sound options and their corresponding audio files</p>

            </p>




            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Static</span>
                                <a href="#none">none</a>
                            </li>
                            <li>
                                    <span class="modifier">Static</span>
                                <a href="#type1">type1</a>
                            </li>
                            <li>
                                    <span class="modifier">Static</span>
                                <a href="#type2">type2</a>
                            </li>
                            <li>
                                    <span class="modifier">Static</span>
                                <a href="#type3">type3</a>
                            </li>
                            <li>
                                    <span class="modifier">Static</span>
                                <a href="#type4">type4</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Static</span>
                                <a href="#getSoundsource">getSoundsource</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>


            <section>
    
        <h3 id="inputs">
            Properties
        </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="none"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Static</span>
                            none
                            </b>
                            <a href="#none"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span><code>none:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>&#x27;&#x27;</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="20" class="link-to-prism">src/app/data/alarm.service.ts:20</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description"><p>This is the type for alarms with no sound </p>
</div>
                    </td>
                </tr>

            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="type1"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Static</span>
                            type1
                            </b>
                            <a href="#type1"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span><code>type1:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>&#x27;Alarm_Sound_1.mp3&#x27;</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="23" class="link-to-prism">src/app/data/alarm.service.ts:23</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description"><p>The name of the audio file associated to the sound TYPE1 </p>
</div>
                    </td>
                </tr>

            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="type2"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Static</span>
                            type2
                            </b>
                            <a href="#type2"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span><code>type2:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>&#x27;Alarm_Sound_2.mp3&#x27;</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="26" class="link-to-prism">src/app/data/alarm.service.ts:26</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description"><p>The name of the audio file associated to the sound TYPE2 </p>
</div>
                    </td>
                </tr>

            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="type3"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Static</span>
                            type3
                            </b>
                            <a href="#type3"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span><code>type3:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>&#x27;Alarm_Sound_3.mp3&#x27;</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="29" class="link-to-prism">src/app/data/alarm.service.ts:29</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description"><p>The name of the audio file associated to the sound TYPE3 </p>
</div>
                    </td>
                </tr>

            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="type4"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Static</span>
                            type4
                            </b>
                            <a href="#type4"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span><code>type4:     <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>&#x27;Alarm_Sound_4.mp3&#x27;</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="32" class="link-to-prism">src/app/data/alarm.service.ts:32</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description"><p>The name of the audio file associated to the sound TYPE4 </p>
</div>
                    </td>
                </tr>

            </tbody>
        </table>
</section>

            <section>
    
        <h3 id="methods">
            Methods
        </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="getSoundsource"></a>
                        <span class="name">
                            <b>
                                <span class="modifier">Static</span>
                            getSoundsource
                            </b>
                            <a href="#getSoundsource"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                            <span class="modifier-icon icon ion-ios-reset"></span>
                        <code>getSoundsource(sound: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                    </td>
                </tr>


                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="39" class="link-to-prism">src/app/data/alarm.service.ts:39</a></div>
                            </td>
                        </tr>


                <tr>
                    <td class="col-md-4">
                            <div class="io-description"><p>Given a sound type, retruns the associated audiofile</p>
</div>

                            <div class="io-description">
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                                    <td>Description</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>sound</td>
                                                        <td>
                                                                    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                                        </td>
                                                    
                                                    <td>
                                                            No
                                                    </td>
                                                    

                                                        <td>
                                                                <code><p>The sound type, e.g. TYPE1, TYPE2, etc.</p>
</code>
                                                        </td>
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                            <div>
                            </div>
                            <div class="io-description">
                                <b>Returns : </b>    <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                            </div>
                                <div class="io-description">
                                    <p>the filepath of the corresponding audio file</p>

                                </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>






    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable } from &#x27;@angular/core&#x27;;
import { map } from &#x27;rxjs/operators&#x27;;
import { Observable ,  BehaviorSubject } from &#x27;rxjs&#x27;;
import { IntervalObservable } from &#x27;rxjs/observable/IntervalObservable&#x27;;
import { WebSocketBridge } from &#x27;django-channels&#x27;;
import { environment } from &#x27;../../environments/environment&#x27;;
import { Alarm, OperationalMode, Validity, Value } from &#x27;../data/alarm&#x27;;
import { BackendUrls, Streams, Assets } from &#x27;../settings&#x27;;
import { CdbService } from &#x27;../data/cdb.service&#x27;;
import { HttpClientService } from &#x27;./http-client.service&#x27;;
import { AuthService } from &#x27;../auth/auth.service&#x27;;


/**
* Class used to model the different sound options and their corresponding audio files
*/
export class AlarmSounds {

  /** This is the type for alarms with no sound */
  static none &#x3D; &#x27;&#x27;;

  /** The name of the audio file associated to the sound TYPE1 */
  static type1 &#x3D; &#x27;Alarm_Sound_1.mp3&#x27;;

  /** The name of the audio file associated to the sound TYPE2 */
  static type2 &#x3D; &#x27;Alarm_Sound_2.mp3&#x27;;

  /** The name of the audio file associated to the sound TYPE3 */
  static type3 &#x3D; &#x27;Alarm_Sound_3.mp3&#x27;;

  /** The name of the audio file associated to the sound TYPE4 */
  static type4 &#x3D; &#x27;Alarm_Sound_4.mp3&#x27;;

  /**
  * Given a sound type, retruns the associated audiofile
  * @param {string} sound The sound type, e.g. TYPE1, TYPE2, etc.
  * @returns {string} the filepath of the corresponding audio file
  */
  static getSoundsource(sound: string): string {
    if (sound &#x3D;&#x3D;&#x3D; &#x27;TYPE1&#x27;) {
      return Assets.SOUNDS + AlarmSounds.type1;
    } else if (sound &#x3D;&#x3D;&#x3D; &#x27;TYPE2&#x27;) {
      return Assets.SOUNDS + AlarmSounds.type2;
    } else if (sound &#x3D;&#x3D;&#x3D; &#x27;TYPE3&#x27;) {
      return Assets.SOUNDS + AlarmSounds.type3;
    } else if (sound &#x3D;&#x3D;&#x3D; &#x27;TYPE4&#x27;) {
      return Assets.SOUNDS + AlarmSounds.type4;
    }
  }
}

/**
* Service that connects and receives {@link Alarm} messages from the
* IAS Webserver through Websockets
*/
@Injectable()
export class AlarmService {

  /**
  * Timestamp related with the last received message
  */
  public lastReceivedMessageTimestamp: number &#x3D; (new Date).getTime();

  /**
  * Stream of notifications of changes in
  * the status of the service connection
  */
  public connectionStatusStream &#x3D; new BehaviorSubject&lt;any&gt;(false);

  /**
  * Array of {@link Alarm} objects
  */
  public alarmsArray: Alarm[] &#x3D; [];

  /**
  * Index for the alarmsArray { core_id: arrayIndex }
  */
  public alarmsIndexes: {[core_id: string]: number} &#x3D; {};

  /**
  * Stream of notifications of changes in
  * the dictionary of {@link Alarm} objects
  */
  public alarmChangeStream &#x3D; new BehaviorSubject&lt;any&gt;(true);

  /**
  * Django Channels WebsocketBridge,
  * used to connect to Django Channels through Websockets
  */
  public webSocketBridge: WebSocketBridge &#x3D; new WebSocketBridge();

  /**
  * Defines wether or not the display should emit sounds when alarms are triggered.
  * It is used to avoid sounds when the page is refreshed, and only allow them after that
  */
  public canSound: boolean;

  /**
  * Reference to the audio object used to play the sounds
  */
  public audio &#x3D; new Audio();

  /**
  * Id of the currenlty sounding Alarm
  */
  public soundingAlarm: string;

  /**
  * Defines wether or not the service is initialized
  */
  public isInitialized &#x3D; false;

  /**
  * Information about the count of alarms by view
  */
  public countByView &#x3D; {};

  /**
  * Connection status timer
  */
  public connectionStatusTimer;

  /**
   * Builds an instance of the service
   * @param {CdbService} cdbService Service used to get complementary alarm information
   * @param {HttpClientService} httpClientService Service used to perform HTTP requests
   * @param {AuthService} authService Service used for authentication
   */
  constructor(
    private cdbService: CdbService,
    private httpClientService: HttpClientService,
    private authService: AuthService,
  ) {
    this.connectionStatusStream.subscribe(
      value &#x3D;&gt; {
        if (value &#x3D;&#x3D;&#x3D; false) {
          this.triggerAlarmsNonValidConnectionState();
        }
      }
    );
    this.authService.loginStatusStream.subscribe(
      value &#x3D;&gt; {
        if (value &#x3D;&#x3D;&#x3D; true) {
          this.initialize();
        } else {
          this.destroy();
        }
      }
    );
  }

  /**
  * Sends an {@link Alarm} change event
  *
  * @param {Any} any the core_id of the updated alarm,
  * or &#x27;all&#x27; if all were updated
  */
  changeAlarms(any) {
    this.alarmChangeStream.next(any);
  }

  /******* SERVICE INITIALIZATION *******/

  /**
  * Start connection to the backend through websockets
  */
  initialize() {
    if (this.isInitialized || !this.authService.loginStatus) {
      return;
    }
    this.cdbService.initialize();
    this.isInitialized &#x3D; true;
    this.canSound &#x3D; false;
    this.audio &#x3D; new Audio();
    this.connect();
    this.webSocketBridge.socket.addEventListener(
      &#x27;open&#x27;, () &#x3D;&gt; {
        this.connectionStatusStream.next(true);
        this.getAlarmList();
      }
    );
    this.webSocketBridge.socket.addEventListener(
      &#x27;close&#x27;, () &#x3D;&gt; {
        this.resetCountByView();
      }
    );
    this.webSocketBridge.demultiplex(Streams.ALARMS, (payload, streamName) &#x3D;&gt; {
      // console.log(&#x27;notify &#x27;, payload);
      if (this.authService.loginStatus) {
        this.resetTimer();
        this.readAlarmMessage(payload.action, payload.data);
      }
    });
    this.webSocketBridge.demultiplex(Streams.UPDATES, (payload, streamName) &#x3D;&gt; {
      // console.log(&#x27;request&#x27;, payload);
      if (this.authService.loginStatus) {
        this.resetTimer();
        this.readAlarmMessagesList(payload.data);
      }
    });
    this.webSocketBridge.demultiplex(Streams.COUNTER, (payload, streamName) &#x3D;&gt; {
      // console.log(&#x27;counter &#x27;, payload);
      if (this.authService.loginStatus) {
        this.readCountByViewMessage(payload.data);
      }
    });
  }

  /**
  *  Start connection to the backend through websockets
  */
  connect() {
    const connectionPath &#x3D; this.getConnectionPath();
    this.webSocketBridge.connect(connectionPath);
    this.webSocketBridge.listen(connectionPath);
    console.log(&#x27;Connected to webserver at: &#x27; + environment.websocketPath);
  }

  /**
  *  Connection path using authentication data
  */
  getConnectionPath() {
    return environment.websocketPath + &#x27;?token&#x3D;&#x27; + this.authService.getToken();
  }

  /**
  *  Disconnect from the backend
  */
  destroy() {
    // Close connection
    if (this.isInitialized) {
      this.webSocketBridge.stream(Streams.UPDATES).send({
        &#x27;action&#x27;: &#x27;close&#x27;
      });
      this.webSocketBridge.socket.close(
        1000, &#x27;User logout&#x27;, {keepClosed: true});
      this.resetCountByView();
    }
    this.isInitialized &#x3D; false;
    console.log(&#x27;Connection to webserver closed&#x27;);
  }

  /******* ALARM HANDLING *******/

  /**
   * Returns an Alarm object
   * @param core_id core_id of the Alarm to return
   * @returns {Alarm} Alarm object corresponding to the given core_id
   */
  get(core_id: string): Alarm {
    return this.alarmsArray[this.alarmsIndexes[core_id]] as Alarm;
  }

  /**
   * Acknowledges a list of Alarms with a message
   * @param alarms list of ids of the alarms to acknowledge
   * @param message message of the acknowledgement
   * @param user user that performs the acknowledgement
   * @returns {json} response of the HTTP request of the acknowledge
   */
  acknowledgeAlarms(alarms_ids, message, user) {
    const data &#x3D; {
      &#x27;alarms_ids&#x27;: alarms_ids,
      &#x27;message&#x27;: message,
      &#x27;user&#x27;: user
    };
    return this.httpClientService.put(BackendUrls.TICKETS_MULTIPLE_ACK, data).pipe(
    map(
      (response) &#x3D;&gt; {
        for (const id of alarms_ids) {
          const alarm &#x3D; this.get(id);
          alarm.acknowledge();
        }
        return response;
      }
    ));
  }

  /**
   * Get information about old tickets related to a target alarm
   * @param alarm_id id of the target alarm
   * @returns {json} response of the HTTP request with a dictionary with information about missing acks
   */
  getMissingAcks(alarm_id) {
    const url &#x3D; BackendUrls.TICKETS_INFO + &#x27;?alarm_id&#x3D;&#x27; + alarm_id;
    return this.httpClientService.get(url).pipe(
    map(
      (response) &#x3D;&gt; {
        return response;
      }
    ));
  }

  /**
   * Gets the open {@link ShelveRegistry} for an {@link Alarm}
   * @param {string} alarm_id id of the target alarm
   * @param {int} status id of the target alarm
   * @returns {json} response of the HTTP request with a dictionary with information about missing acks
   */
  getShelveRegistries(alarm_id, status) {
    const url &#x3D; BackendUrls.SHELVE_REGS_FILTER + &#x27;?alarm_id&#x3D;&#x27; + alarm_id + &#x27;&amp;status&#x3D;&#x27; + status;
    return this.httpClientService.get(url).pipe(
    map(
      (response) &#x3D;&gt; {
        return response;
      }
    ));
  }

  /**
   * Shelves and {@link Alarm} with a message
   * @param {string} alarm_id id of the alarm to shelve
   * @param {string} message message of the shelving
   * @param {string} timeout the timeout for the shelving
   * @returns {json} response of the HTTP request of the shelve
   */
  shelveAlarm(alarm_id, message, timeout, user) {
    const data &#x3D; {
      &#x27;alarm_id&#x27;: alarm_id,
      &#x27;message&#x27;: message,
      &#x27;timeout&#x27;: timeout,
      &#x27;user&#x27;: user
    };
    return this.httpClientService.post(BackendUrls.SHELVE_API, data).pipe(
    map(
      (response) &#x3D;&gt; {
        if (response[&#x27;status&#x27;] &#x3D;&#x3D;&#x3D; 201) {
          const alarm &#x3D; this.get(alarm_id);
          alarm.shelve();
        }
        return response;
      }
    ));
  }

  /**
   * Shelves and {@link Alarm} with a message
   * @param {string} alarms_ids id of the alarm to shelve
   * @param {string} message message of the shelving
   * @returns {json} response of the HTTP request of the shelve
   */
  unshelveAlarms(alarms_ids, message) {
    const data &#x3D; {
      &#x27;alarms_ids&#x27;: alarms_ids,
    };
    return this.httpClientService.put(BackendUrls.UNSHELVE_API, data).pipe(
    map(
      (response) &#x3D;&gt; {
        if (response[&#x27;status&#x27;] &#x3D;&#x3D;&#x3D; 200) {
          for (const id of alarms_ids) {
            const alarm &#x3D; this.get(id);
            alarm.unshelve();
          }
        }
        return response;
      }
    ));
  }

  /******* HANDLING OF ALARM MESSAGES FROM THE CORE *******/

  /**
  * Get the complete list of alarms from the webserver database
   * through the websocket
   */
  getAlarmList() {
    this.webSocketBridge.stream(Streams.UPDATES).send({
      &#x27;action&#x27;: &#x27;list&#x27;
    });
  }

  /**
   * Reads an alarm message from the Core and modify the service alarms list
   * depending on the action value.
   * @param {string} action create, update or delete
   * @param {Object} obj dictionary with values for alarm fields (as generic object)
   */
  readAlarmMessage(action, obj) {
    if ( action &#x3D;&#x3D;&#x3D; &#x27;create&#x27; || action &#x3D;&#x3D;&#x3D; &#x27;update&#x27; ) {
      const alarm &#x3D; Alarm.asAlarm(obj);
      this.add_or_update_alarm(alarm);
      this.changeAlarms(alarm.core_id);
    }
  }

  /**
   * Reads a list of alarm messages form the Core and add them to the
   * service alarms list
   * @param {Object[]} alarmsList list of dictionaries with values for alarm fields (as generic objects)
   */
  readAlarmMessagesList(alarmsList) {
    for (const obj of alarmsList) {
      const alarm &#x3D; Alarm.asAlarm(obj);
      this.add_or_update_alarm(alarm);
    }
    this.changeAlarms(&#x27;all&#x27;);
    this.canSound &#x3D; true;
  }

  /**
   * Reads the count by view object received from the webserver
   * @param {Object} countByView
   */
  readCountByViewMessage(countByView) {
    this.countByView &#x3D; countByView;
  }

  /**
   * Method to clear the count by view if there is the ws connection is closed
   */
  resetCountByView() {
    this.countByView &#x3D; {};
  }

  /**
   * Adds or updates an {@link Alarm} to the AlarmService
   * @param {Alarm} alarm the {@link Alarm} to add or update
   */
  add_or_update_alarm(alarm) {
    let old_alarm_value &#x3D; Value.cleared;
    let old_alarm_ack &#x3D; true;
    if (alarm.core_id in this.alarmsIndexes) {
      const old_alarm &#x3D; this.alarmsArray[this.alarmsIndexes[alarm.core_id]];
      old_alarm_value &#x3D; old_alarm.value;
      old_alarm_ack &#x3D; old_alarm.ack;
      this.alarmsArray[this.alarmsIndexes[alarm.core_id]] &#x3D; alarm;
    } else {
      const newLength &#x3D; this.alarmsArray.push(alarm);
      this.alarmsIndexes[alarm.core_id] &#x3D; newLength - 1;
    }
    if (old_alarm_value &#x3D;&#x3D;&#x3D; Value.cleared &amp;&amp; alarm.value !&#x3D;&#x3D; Value.cleared) {
      if (alarm.sound !&#x3D;&#x3D; &#x27;NONE&#x27;) {
        this.playAlarmSound(alarm);
      }
    }
    if (!old_alarm_ack &amp;&amp; alarm.ack) {
      if (alarm.sound !&#x3D;&#x3D; &#x27;NONE&#x27;) {
        this.clearSoundsIfAck(alarm);
      }
    }
  }

  /**
   * Reproduces the sound of a given {@link Alarm}
   * @param {Alarm} alarm the {@link Alarm}
   */
  playAlarmSound(alarm: Alarm) {
    if (!this.canSound) {
      return;
    }
    const repeat &#x3D; alarm.shouldRepeat();
    if (repeat) {
      this.soundingAlarm &#x3D; alarm.core_id;
      this.audio.pause();
      this.emitSound(alarm.sound, repeat);
    } else if (this.audio.paused) {
      this.emitSound(alarm.sound, repeat);
    }
  }

  /**
   * Reproduces a sound
   * @param {string} sound the type of sound to reproduce
   * @param {boolean} repeat true if the sound should be repeated, false if not
   */
  emitSound(sound: string, repeat: boolean) {
    console.log(&#x27;calling emit with: &#x27;, sound);
    this.audio &#x3D; new Audio();
    this.audio.src &#x3D; AlarmSounds.getSoundsource(sound);
    if (repeat) {
      this.audio.addEventListener(&#x27;ended&#x27;, function() {
        this.currentTime &#x3D; 0;
        this.play();
      }, false);
    }
    this.audio.load();
    this.audio.play();
  }

  /**
   * Stops the sound of a given {@link Alarm}, only if the sound is being repeated
   * It is intended to be used when critical alarms (repeated) are acknowledged.
   * Once the sound stops, it check there is another non-acknowledged alarm and plays its sound repeatedly,
   * by calling {@link AlarmService.html#playAlarmSound}
   * @param {Alarm} alarm the {@link Alarm}
   */
  clearSoundsIfAck(alarm: Alarm) {
    if (!alarm.shouldRepeat()) {
      return;
    }
    if (this.soundingAlarm &#x3D;&#x3D;&#x3D; alarm.core_id) {
      this.audio.pause();
      this.soundingAlarm &#x3D; null;
      for (alarm of this.alarmsArray) {
        if (!alarm.ack &amp;&amp; alarm.sound !&#x3D;&#x3D; &#x27;NONE&#x27; &amp;&amp; alarm.shouldRepeat()) {
          this.soundingAlarm &#x3D; alarm.core_id;
          this.playAlarmSound(alarm);
          return;
        }
      }
    }
  }

  /******* PERIODIC CHECK OF VALIDITY OF ALARMS *******/

  /**
   * Set selected state to alarms under an non-valid connection
   */
  triggerAlarmsNonValidConnectionState() {
    for (const alarm of this.alarmsArray) {
      alarm.validity &#x3D; Validity.unreliable;
    }
    this.changeAlarms(&#x27;all&#x27;);
  }

  /**
   * Resets the status connection check timer
   * The timer&#x27;s period is equal to the broadcastThreshold obtained by {@link CdbService.html#getBroadcastRate}
   */
  resetTimer() {
    if (this.connectionStatusTimer) {
      this.connectionStatusTimer.unsubscribe();
      this.connectionStatusStream.next(true);
    }
    const broadcastThreshold &#x3D; this.cdbService.getBroadcastThreshold();
    this.connectionStatusTimer &#x3D; IntervalObservable.create(1000 * broadcastThreshold).subscribe(x &#x3D;&gt; {
      this.connectionStatusStream.next(false);
    });
  }
}
</code></pre>
    </div>
</div>







                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'class';
            var COMPODOC_CURRENT_PAGE_URL = 'AlarmSounds.html';
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
